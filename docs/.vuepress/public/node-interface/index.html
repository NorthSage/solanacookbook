<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Solana Node Flow Demo</title>
  <script src="https://unpkg.com/rete@1.4.4/build/rete.min.js"></script>
  <script src="https://unpkg.com/rete-connection-plugin@0.9.0/build/connection-plugin.min.js"></script>
  <script src="https://unpkg.com/rete-area-plugin@0.2.1/build/area-plugin.min.js"></script>
  <script src="https://unpkg.com/rete-vue-render-plugin@0.3.3/build/vue-render-plugin.min.js"></script>
  <script src="https://unpkg.com/vue@2.6.14/dist/vue.min.js"></script>
  <style>
    html, body { margin: 0; height: 100%; overflow: hidden; }
    #editor { width: 100%; height: 100%; }
  </style>
</head>
<body>
  <div id="editor"></div>
  <script type="module">
    import { Connection, Keypair, PublicKey, Transaction, TransactionInstruction } from 'https://cdn.skypack.dev/@solana/web3.js';
    import nacl from 'https://cdn.skypack.dev/tweetnacl';

    const objSocket = new Rete.Socket('object');
    const boolSocket = new Rete.Socket('bool');

    class GenerateKeypairComponent extends Rete.Component {
      constructor() { super('Generate Keypair'); }
      builder(node) {
        node.addOutput(new Rete.Output('kp', 'Keypair', objSocket));
      }
      worker(node, inputs, outputs) {
        outputs.kp = Keypair.generate();
      }
    }

    class VerifySignatureComponent extends Rete.Component {
      constructor() { super('Verify Signature'); }
      builder(node) {
        node.addInput(new Rete.Input('msg', 'Message', objSocket));
        node.addInput(new Rete.Input('sig', 'Signature', objSocket));
        node.addInput(new Rete.Input('pub', 'PublicKey', objSocket));
        node.addOutput(new Rete.Output('valid', 'Valid', boolSocket));
      }
      worker(node, inputs, outputs) {
        const [message] = inputs.msg;
        const [signature] = inputs.sig;
        const [pub] = inputs.pub;
        outputs.valid = nacl.sign.detached.verify(message, signature, pub.toBytes());
      }
    }

    class CustomTransactionComponent extends Rete.Component {
      constructor() { super('Custom Transaction'); }
      builder(node) {
        node.addInput(new Rete.Input('ix', 'Instruction', objSocket));
        node.addOutput(new Rete.Output('tx', 'Transaction', objSocket));
      }
      worker(node, inputs, outputs) {
        const [ix] = inputs.ix;
        outputs.tx = new Transaction().add(ix);
      }
    }

    class SendTransactionComponent extends Rete.Component {
      constructor() { super('Send Transaction'); }
      builder(node) {
        node.addInput(new Rete.Input('conn', 'Connection', objSocket));
        node.addInput(new Rete.Input('tx', 'Transaction', objSocket));
        node.addInput(new Rete.Input('signer', 'Keypair', objSocket));
      }
      async worker(node, inputs) {
        const [conn] = inputs.conn;
        const [tx] = inputs.tx;
        const [signer] = inputs.signer;
        await conn.sendTransaction(tx, [signer]);
      }
    }

    async function createEditor() {
      const container = document.getElementById('editor');
      const editor = new Rete.NodeEditor('demo@0.1', container);
      editor.use(ConnectionPlugin);
      editor.use(AreaPlugin);
      editor.use(VueRenderPlugin);

      const comps = [
        new GenerateKeypairComponent(),
        new VerifySignatureComponent(),
        new CustomTransactionComponent(),
        new SendTransactionComponent()
      ];
      comps.forEach(c => editor.register(c));

      editor.view.resize();
      AreaPlugin.zoomAt(editor);
    }

    createEditor();
  </script>
</body>
</html>
